@page "/register"
@using BabySounds.Client.Services
@using BabySounds.Contracts.Requests
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

@if (_showErrors)
{
    <div class="alert alert-danger" role="alert">
        @foreach (var error in _errors)
        {
            <p>@error</p>
        }
    </div>
}

<div>
    <div class="mb-10 text-lg font-semibold text-white">Please enter your details to register</div>

    <EditForm Model="_registerModel" OnValidSubmit="HandleRegistration">
        <DataAnnotationsValidator/>
        <ValidationSummary/>

        <div class="mb-6 rounded-lg bg-white py-2">
            <input id="firstName" class="w-full px-4 py-4 text-gray-700" placeholder="First Name" @bind="_registerModel.FirstName"/>
            <ValidationMessage For="@(() => _registerModel.UserName)" class="text-red-500"/>
        </div>

        <div class="mb-6 rounded-lg bg-white py-2">
            <input id="email" class="w-full px-4 py-4 text-gray-700" placeholder="Email" @bind="_registerModel.Email"/>
            <ValidationMessage For="@(() => _registerModel.Email)" class="text-red-500"/>
        </div>

        <div class="mb-6 rounded-lg bg-white py-2">
            <input id="username" class="w-full px-4 py-4 text-gray-700" placeholder="Username" @bind="_registerModel.UserName"/>
            <ValidationMessage For="@(() => _registerModel.UserName)" class="text-red-500"/>
        </div>

        <div class="justfy-between mb-4 flex">
            <div class="rounded-lg bg-white py-2">
                <input id="password" type="password" class="w-full px-4 py-4 text-gray-700" placeholder="Password" @bind="_registerModel.Password"/>
                <ValidationMessage For="@(() => _registerModel.Password)" class="mt-1 text-red-500"/>
            </div>
            <div class="ms-4 rounded-lg bg-white py-2">
                <input id="confirmPassword" type="password" class="w-full px-4 py-4 text-gray-700" placeholder="Confirm Password" @bind="_registerModel.Password"/>
                <ValidationMessage For="@(() => _registerModel.ConfirmPassword)" class="mt-1 text-red-500"/>
            </div>
        </div>

        <div class="my-4 h-4">
            <input type="checkbox" class="form-checkbox w-4 text-purple-600"/>
            <label for="agreements" class="ml-2 text-white">I agree to the terms and conditions</label>
        </div>

        <button type="submit" class="mt-4 w-full rounded bg-pink-900 px-6 py-4 font-semibold text-white hover:bg-pink-950">Sing Up</button>
    </EditForm>
</div>

@code {

    private readonly RegisterRequest _registerModel = new()
    {
        FirstName = "",
        UserName = "",
        Email = "",
        Password = "",
        ConfirmPassword = ""
    };

    private bool _showErrors;
    private IEnumerable<string> _errors = new List<string>();

    private async Task HandleRegistration()
    {
        _showErrors = false;

        var response = await AuthService.Register(_registerModel);

        response.Switch(
            _ => NavigationManager.NavigateTo("/"),
            failure =>
            {
                _errors = failure.Select(x => x.Description);
                _showErrors = true;
            });
    }

}
